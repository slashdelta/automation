# Terraform Proxmox VM Module

This Terraform configuration creates Proxmox VMs using variables generated by the setup.sh script. It supports both standalone and clustered Proxmox deployments with automatic Ubuntu template creation.

## Features

- **Dynamic VM Creation**: Creates VMs based on setup.sh configuration
- **Cluster Support**: Handles both standalone and clustered Proxmox setups
- **Template Management**: Automatically downloads and creates Ubuntu cloud templates
- **Comprehensive Configuration**: Supports CPU, memory, disk, network, and user settings
- **Variable Integration**: Seamlessly integrates with setup.sh script variables

## Usage

### Prerequisites

1. Run the setup.sh script first to configure your Proxmox environment
2. Complete the PVE Host configuration and get details
3. Configure VM settings through the Terraform menu
4. Generate variables using the "Generate Variables" option

### Running Terraform

```bash
# Initialize Terraform
cd terraform
terraform init

# Plan the deployment
terraform plan

# Apply the configuration
terraform apply

# View outputs
terraform output
```

### Configuration Files

- `variables.tf` - Variable definitions matching setup.sh output
- `main.tf` - Main Terraform configuration with template creation
- `outputs.tf` - Output definitions for VM information
- `terraform.tfvars` - Generated by setup.sh script (do not edit manually)
- `terraform.tfvars.example` - Example variable file

## Module Structure

### Main Module (`terraform/`)
- **Provider**: Configures Proxmox provider
- **Template Creation**: Downloads Ubuntu cloud images if needed
- **VM Creation**: Uses the proxmox_vm module

### Proxmox VM Module (`terraform/modules/proxmox_vm/`)
- **variables.tf**: All variable definitions
- **main.tf**: VM resource creation logic
- **outputs.tf**: VM information outputs
- **user-data.tftpl**: Cloud-init configuration template

## Variables

### Proxmox Connection
- `proxmox_api_url` - Proxmox API endpoint
- `proxmox_api_user` - API user
- `proxmox_api_token` - API token

### Host Configuration
- `pve_host_ip` - PVE host IP address
- `pve_clustered` - Boolean for cluster mode
- `pve_cluster_name` - Cluster name (if clustered)

### Node Configuration
- `node_names` - List of node names
- `node_ips` - List of node IP addresses
- `vm_distribution` - VM distribution across nodes (clustered only)

### Template Configuration
- `template_id` - Template VM ID (default: 9000)
- `template_node` - Node where template is created
- `create_template` - Auto-create template if missing
- `ubuntu_version` - Ubuntu version (default: noble)
- `ubuntu_image_url` - Ubuntu cloud image URL

### VM Configuration
- `vm_count` - Number of VMs to create
- `vm_cpu_cores` - CPU cores per VM
- `vm_cpu_type` - CPU type (host, kvm64, etc.)
- `vm_memory` - RAM in GB
- `vm_disk_size` - Disk size in GB
- `vm_machine_type` - Machine type (q35, i440fx, pc)
- `vm_bios_type` - BIOS type (UEFI, BIOS)

### Network Configuration
- `vm_network_bridge` - Network bridge
- `vm_network_cidr` - Network CIDR
- `vm_starting_ip` - Starting IP address
- `vm_gateway` - Gateway IP

### User Configuration
- `vm_username` - VM username
- `vm_password` - VM password (optional)
- `vm_hostname_prefix` - Hostname prefix
- `vm_hostname_suffix` - Starting hostname number
- `vm_ssh_keys` - List of SSH public keys

## Deployment Examples

### Standalone Deployment
```hcl
pve_clustered = false
node_names = ["pve-host"]
vm_count = 3
vm_distribution = {}  # Not used for standalone
```

### Clustered Deployment
```hcl
pve_clustered = true
node_names = ["node1", "node2", "node3"]
vm_count = 6
vm_distribution = {
  "node1" = 2
  "node2" = 2
  "node3" = 2
}
```

## Outputs

- `vm_summary` - Overview of all created VMs
- `vm_details` - Detailed VM information
- `cluster_configuration` - Cluster setup details
- `network_configuration` - Network settings
- `connection_info` - SSH connection examples
- `infrastructure_summary` - Complete deployment summary

## Template Creation

The module automatically:
1. Checks if template VM exists
2. Downloads Ubuntu cloud image if needed
3. Creates template VM with proper configuration
4. Configures cloud-init, QEMU guest agent, and EFI
5. Converts to template for VM cloning

## Integration with setup.sh

The setup.sh script:
1. Collects all configuration through interactive dialogs
2. Validates input and provides real-time feedback
3. Generates `terraform.tfvars` file automatically
4. Updates variables every time configuration changes
5. Provides comprehensive summaries and status indicators

## Troubleshooting

### Common Issues

1. **Template Creation Fails**
   - Check internet connectivity for image download
   - Verify storage pool exists and has space
   - Ensure proper permissions for template creation

2. **VM Creation Fails**
   - Verify template exists and is accessible
   - Check network bridge configuration
   - Ensure sufficient resources on target nodes

3. **Network Configuration Issues**
   - Verify CIDR and IP ranges don't conflict
   - Check gateway accessibility
   - Ensure bridge exists on target nodes

### Debugging

```bash
# Enable Terraform debugging
export TF_LOG=DEBUG
terraform apply

# Check Proxmox logs
journalctl -u pvedaemon -f

# Verify template exists
qm list | grep 9000
```

## Security Considerations

- Store API tokens securely
- Use SSH key authentication when possible
- Implement network segmentation
- Regular security updates for templates
- Monitor VM access and usage

## Version Requirements

- Terraform >= 1.0
- Proxmox VE >= 6.0
- Ubuntu >= 20.04 (for templates)
- Bash >= 4.0 (for setup.sh)
- bpg/proxmox provider (latest version)
